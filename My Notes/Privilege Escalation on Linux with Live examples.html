<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.13.1 (455785)"/><meta name="keywords" content="linux, OSCP, Privilege Escalation, Security"/><meta name="author" content="Anas"/><meta name="created" content="2018-01-11 12:29:10 +0000"/><meta name="source" content="Clearly"/><meta name="source-url" content="http://resources.infosecinstitute.com/privilege-escalation-linux-live-examples/"/><meta name="updated" content="2018-01-11 20:48:28 +0000"/><title>Privilege Escalation on Linux with Live examples</title></head><body><div><br/></div><div><h1>Introduction</h1></div><div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">One of the most important phase during penetration testing or vulnerability assessment is <a href="http://searchsecurity.techtarget.com/definition/privilege-escalation-attack" target="_blank">Privilege Escalation</a>. During that step, hackers and security researchers attempt to find out a way (exploit, bug, misconfiguration) to escalate between the system accounts. Of course, vertical privilege escalation is the ultimate goal. For many security researchers, this is a fascinating phase.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">In the next lines, we will see together several real examples of privilege escalation. We will use labs that are currently hosted at <a href="https://www.vulnhub.com/" target="_blank">Vulnhub</a>. Of course, we are not going to review the whole exploitation procedure of each lab. Instead, we will suppose that we have already gained access to the machine and, together, we will move from an unprivileged user into the root.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">We will perform all the privilege escalation techniques manually. This means that no automatic tools will be used to escalate the privileges. Of course, though, tools and papers will be given as reference at the end of the article. Before you begin reading the next lines, I suggest you have a look at my personal Privilege Escalation Bible: <a href="https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/" target="_blank">G0tmi1k: Basic Linux Privilege Escalation</a> written by the very talented <a href="https://twitter.com/g0tmi1k" target="_blank">g0tmi1k</a>.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">The purpose of the article is to give you an idea of how privilege escalation looks and works on real machines. We will not attempt to explain all the available techniques as this would require several articles and at the same time, g0tmi1k and other people have done this before, perfectly.</div><h1>Lab 1: <a href="https://www.vulnhub.com/entry/vulnos-2,147/" target="_blank">VulnOS 2</a></h1><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">VulnOS version 2 is a very common boot to root lab available at Vulnhub. Once someone manages to exploit the vulnerability and gain a shell, we will probably see something like the following:</div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs1.png" height="203" width="602"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">The things that we should do first are:</div><ol><li>Check the OS Release of the vulnerable system</li><li>View its Kernel Version</li><li>Check the available users and the current user privileges</li><li>List the SUID files. Read more here: <a href="http://resources.infosecinstitute.com/linux-misconfigurations/" target="_blank">Common Linux Misconfigurations – InfoSec Resources – InfoSec Institute</a></li><li>View the installed packages, programs and running services. Outdated versions might be vulnerable.</li></ol><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Of course, each time we will be looking for other information but for now, the above will do the job.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Let’s try to view the OS Release of the lab machine. By executing:</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><span style="font-weight: bold; font-style: italic;">$ lsb_release -a</span></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">We can see something like the following:</div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs2.png" height="163" width="602"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Moreover, by running:</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><span style="font-weight: bold; font-style: italic;">$ uname -a</span></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">We can also see the Kernel Version:</div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs3.png" height="177" width="602"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">During privilege escalation, we will find ourselves testing again and again. We will be searching for possible techniques to escalate and each time one comes to our mind; we will attempt to apply it. We will be testing exploits against the system, exploits against services, we will brute force credentials and in general, we will be testing all the time.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Now that we know the OS Release Information, <span style="font-style: italic;">Ubuntu 14.04.4 LTS</span>, and the Kernel Version, <span style="font-style: italic;">3.13.0-24-generic</span>, the first thing we can try is the popular exploit called: <a href="https://www.exploit-db.com/exploits/37292/" style="font-weight: bold;">overlayfs</a>. This exploit is supposed to work on <span style="font-style: italic;">Ubuntu 12.04/14.04/14.10/15.04</span> and Linux Kernel after 3.13.0 and before 3.19. So, it should work fine. Let’s test it.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">We first move to the <span style="font-style: italic;">tmp</span> directory which we will be able to create a file, paste the exploit code and then compile it.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">The commands we should run are:</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><span style="font-weight: bold; font-style: italic;">$ cd /tmp</span></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><span style="font-weight: bold; font-style: italic;">$ touch exploit.c</span></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><span style="font-weight: bold; font-style: italic;">$ vim exploit.c</span></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Then, we should paste the exploit code inside the file, save and exit. Now, we have to compile the exploit. To do this we run:</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><span style="font-weight: bold; font-style: italic;">$ gcc exploit.c -o exploit</span></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">And now we only have to execute the exploit file to see if our exploit works. By running:</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><span style="font-weight: bold; font-style: italic;">$ ./exploit</span></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">We can see something like the following:</div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs4.png" height="316" width="602"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">As you can see, the exploit has been executed successfully, and we have root access. The python command you can see was used to get a proper shell. The command used:</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><span style="font-weight: bold; font-style: italic;">$ python -c ‘import pty; pty.spawn(“/bin/bash”)’</span></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Even if this wasn’t a difficult lab to perform privilege escalation, the method used is one of the most common techniques, and it applies to several systems. I personally suggest you to always check if the overlayfs exploit works. Keep in mind that there are several versions of this exploit which apply even to newer kernel versions. Have a look here:</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Make sure you use the proper one according to the kernel version!</div><h1>Lab 2: <a href="https://www.vulnhub.com/entry/mr-robot-1,151/" target="_blank">Mr.Robot</a></h1><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Mr.Robot is another boot to root challenge and one of the author’s most favorite. I decided to show its privilege escalation part because it will help you understand the importance of the SUID files. If you don’t know what SUID files are, please have a look <a href="https://en.wikipedia.org/wiki/Setuid" target="_blank">here</a>.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Once we manage to access the shell, we can see something like this:</div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs5.png" height="113" width="602"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Here, we have accessed an account with username “<span style="font-weight: bold;">daemon</span>“. Let’s see how we will manage to escalate from <span style="font-weight: bold;">daemon</span> to <span style="font-weight: bold;">root</span>.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">This box is an <span style="font-style: italic;">Ubuntu 14.04 trusty</span> with Linux Kernel version: <span style="font-style: italic;">3.13.0-55-generic.</span> All the exploits against the OS and the Linux Kernel have failed.</div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs6.png" height="139" width="516"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Thus, we should come up with a new idea. As mentioned previously, we should always be checking the SUID files available in the system. By running:</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><span style="font-weight: bold; font-style: italic;">$ find / -perm -u=s -type f 2&gt;/dev/null</span></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">We can see something like the following:</div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs7.png" height="255" width="602"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Here, we have listed all the SUID files. Can you notice something strange? Why would <a href="https://nmap.org/" target="_blank">Nmap</a> have the SUID flags? Let’s see.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">First, we should run the following command to learn Nmap’s version:</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><span style="font-weight: bold; font-style: italic;">$ /usr/local/bin/nmap –version</span></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">And the output is:</div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs8.png" height="97" width="602"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">An outdated version of nmap is installed! But how can this help us escalate to a privileged user?</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Back in the day, Nmap supported an option called “<span style="font-style: italic; font-weight: bold;">interactive</span><span style="font-style: italic;">.”</span> With this option, users were able to execute shell commands by using a nmap “shell” (<span style="font-weight: bold;">interactive shell</span>). Many times, security researchers were using this option to avoid logging their nmap commands in the bash history log file. Here is how nmap interactive looks like:</div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs9.png" height="344" width="602"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">As we can see, we can execute shell commands by typing “<span style="font-weight: bold;">!</span>” followed by the command we would like to execute.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Thus, the: <span style="font-weight: bold;">“!sh”</span> command should normally pop a shell. And as nmap has the SUID flags, we should normally get a root shell.</div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs10.png" height="87" width="602"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">And, we are in! We can now execute commands as root.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">It is true that during your tests you will -probably- never find Nmap 3.48 with SUID flags set. This example was demonstrated to make you understand how important is to check for SUID in Linux. There are several labs at Vulnhub based on this technique. Every time, different programs have been assigned with the SUID flags so that you can experiment with them. Feel free to try them.</div><h1>Lab 3: <a href="https://www.vulnhub.com/entry/pwnlab-init,158/" target="_blank">PwnLab-Init</a></h1><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><span style="font-weight: bold;">Pwnlab</span> is another lab hosted by <a href="https://www.vulnhub.com/" target="_blank">Vulnhub</a>. Again, one of the author’s favorite challenges. Once the attacker manages to get a shell (for several accounts but not root), he can see something like this:</div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs11.png" height="104" width="602"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Currently, we are logged in as user “<span style="font-weight: bold;">kane</span>“. Unfortunately for us, the OS Release wasn’t vulnerable to any documented attack. At the same time, none of the kernel exploits helped. Moreover, the SUID files were looking fine except a file located under Kane’s home directory named “<span style="font-weight: bold; font-style: italic;">msgmike.</span>”</div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs12.png" height="287" width="602"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">So, let’s attempt to list the files under the home directory to see what we have.</div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs13.png" height="113" width="688"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">From what we can see, we have an <a href="http://manoharvanga.com/hackme/" style="font-weight: bold; font-style: italic;">ELF 32-bit LSB executable</a>. When executing the file, we get the following error:</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs14.png" height="77" width="602"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">This let us know that the program is trying to call the <a href="http://www.linfo.org/cat.html" style="font-weight: bold; font-style: italic;">cat</a> command to view the contents of a file called <span style="font-weight: bold; font-style: italic;">msg.txt</span> available under the home directory of a user called <span style="font-weight: bold; font-style: italic;">mike</span>. Moreover, let’s recall the the file is SUID. What should we do now?</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">There is a popular <a href="http://www.dankalia.com/tutor/01005/0100501004.htm" target="_blank">technique</a> where attackers manage to manipulate the <a href="http://www.linfo.org/path_env_var.html" style="font-weight: bold;">$PATH</a> bash environmental to escalate their privileges. Imagine what would happen if we edit the $PATH variable and instead of the default value we put a new one, a simple dot (<span style="font-weight: bold;">.</span>). Whenever a program (executable) is called, bash will look at the “.” directory for the program instead of <span style="font-weight: bold; font-style: italic;">/usr/local/bin, /usr/bin</span> and more. Let’s see what this mean.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Ethical Hacking Training – Resources (InfoSec)</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">A normal PATH variable looks like this:</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs15.png" height="73" width="602"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Whenever I call a program – like cat – bash will look for the above directories for it. Let’s make a file called <span style="font-weight: bold;">cat</span> with the following contents inside:</div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs16.png" height="102" width="601"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Of course, we must make it executable with the following command:</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><span style="font-weight: bold; font-style: italic;">$ chmod +x cat</span></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Now, let’s change our PATH variable to “.”. This will make bash look at the “.” (current) directory every time it needs to run a program.</div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs17.png" height="224" width="602"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Can you imagine what would happen if we execute the <span style="font-style: italic;">msgmike</span> program again? As you can recall, <span style="font-style: italic;">msgmike</span> executes the cat command to view the contents of a file (<span style="font-style: italic;">/home/mike/msg.txt</span>). Now that we have changed the PATH variable, though, it will look for the cat program inside the current directory. As we have created an executable file called cat – which pops a shell – our cat file will be executed, and we should normally get a shell as mike. Let’s see!</div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/082316_2247_PrivilegeEs18.png" height="277" width="602"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">As you can see, we have successfully logged in as mike! The real challenge doesn’t stop here, though. The next steps to log in as root are not hard, but we will not cover them as they deal with <a href="https://www.owasp.org/index.php/Command_Injection" target="_blank">Command Injection attacks</a> something that is out of the scope of this article.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">The reason we examined this lab-example is to understand that several times we should think of non-common techniques to perform privilege escalation. It goes without saying that we should first check for common ways to perform privilege escalation but several times you will deal with machines like the previous one.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">I hope you enjoyed this article as much as I did. If you have any questions, please, do not hesitate to comment!</div><div><ul><li>244<br/><a href="#" target="_blank">inShare</a></li></ul></div></div><div><img src="Privilege%20Escalation%20on%20Linux%20with%20Live%20examples.resources/fe211a23a14292d5d0ed0b2754cd5fb9.jpg" height="96" width="96"/></div><div><div>Author</div><h5><a href="http://resources.infosecinstitute.com/author/nikosdanopoulos" target="_blank">Nikos Danopoulos</a></h5></div><div>Nikos Danopoulos has worked as Junior IT Security Researcher at eLearnSecurity. Moreover he was contributed on several projects such as: HACKADEMIC - OWASP, Hack.me and more. You can contact him at danopoulosnikos@gmail.com or you can find him on Twitter: @nikosdanopoulos.</div><div><br/></div></body></html>