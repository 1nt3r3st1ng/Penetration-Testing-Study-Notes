<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.13.1 (455785)"/><meta name="keywords" content="Enumeration, OSCP, port 139, port 445, Security"/><meta name="author" content="Anas"/><meta name="created" content="2018-01-04 06:44:17 +0000"/><meta name="source" content="desktop.win"/><meta name="source-application" content="evernote.win32"/><meta name="updated" content="2018-01-04 15:11:11 +0000"/><title>SMB Enumeration (Server Message Block)</title></head><body><div><ul><li><span style="font-size: 14pt;">Scanning for the NetBIOS Service</span></li></ul></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 11pt;">root@kali:~# nmap -v -p 139,445 192.168.1.12 -oG /tmp/smp.txt</font></div></div><div><div><br style="font-size: 14pt;"/></div><ul><li><span style="font-size: 14pt;">Scanning NetBIOS using nbtscan</span></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 11pt;">root@kali:~# nbtscan -r 192.168.1.12</font></div></div><div><br/></div><div><ul><li><span style="font-size: 14pt;">Null Session Enumeration</span></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 11pt;"><span style="font-size: 11pt; font-family: Monaco; color: rgb(51, 51, 51);">root@kali:~#</span> enum4linux -a 192.168.1.12</font></div></div></div><div><br/></div><div><ul><li><span style="font-size: 14pt;">Nmap SMB NSE Scripts</span></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 11pt;">root@kali:~# ls -la /usr/share/nmap/scripts/smb*</font></div><div><span style="font-family: Monaco; font-size: 11pt; color: rgb(51, 51, 51);">root@kali:~# nmap -v -p 139,445 192.168.1.12 --script smb-os-discovery.nse</span></div></div><div><br/></div><div><ul><li><span style="font-size: 14pt;">SMBCLIENT</span></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 11pt;">root@kali:~#&nbsp;&nbsp;&nbsp;&nbsp;smbclient -L=<span style="font-size: 11pt; font-family: Monaco; color: rgb(51, 51, 51);">192.168.1.12</span></span></div></div><div><br/></div><div><ul><li><font style="font-size: 14pt;"><span style="font-size: 14pt;">Null Sessions</span></font></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 11pt;">root@kali:~#&nbsp;&nbsp;&nbsp;&nbsp;smbclient \\\\192.168.1.12 \\public</span></div><div><span style="font-size: 11pt;">Enter root's password:</span></div><div><span style="font-size: 11pt;">Anonymous login successful</span></div></div><div><br/></div><div><br/></div><div><ul><li><font style="font-size: 14pt;">SMB OS Discovery</font></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>nmap $ip --script smb-os-discovery.ns</div></div><div><br/></div><div><ul><li><font style="font-size: 14pt;">Nmap port scan</font><br/></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>nmap -v -p 139,445 -oG smb.txt $ip-254</div></div><div><ul><li><font style="font-size: 14pt;">Netbios Information Scanning</font><br/></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>nbtscan -r $ip/24</div></div><div><br/></div><div><ul><li><font style="font-size: 14pt;">Nmap find exposed Netbios servers</font><br/></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>nmap -sU --script nbstat.nse -p 137 $ip</div></div><div><div><span style="font-size: 18.6667px;"><br/></span></div><ul><li><font style="font-size: 14pt;">Nmap all SMB scripts scan</font></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>nmap -sV -Pn -vv -p 445 --script='(smb*) and not (brute or broadcast or dos or external or fuzzer)' --script-args=unsafe=1 $ip</div></div><div><div><span style="font-size: 18.6667px;"><br/></span></div><ul><li><font style="font-size: 14pt;">Nmap all SMB scripts authenticated scan</font></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>nmap -sV -Pn -vv -p 445&nbsp;&nbsp;&nbsp;&nbsp;--script-args smbuser=<username>,smbpass=<password> --script='(smb*) and not (brute or broadcast or dos or external or fuzzer)' --script-args=unsafe=1 $ip</div></div><div><div><span style="font-size: 18.6667px;"><br/></span></div><ul><li><font style="font-size: 14pt;">SMB Enumeration Tools</font></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>nmblookup -A $ip</div><div><br/></div><div>smbclient //MOUNT/share -I $ip -N</div><div><br/></div><div>rpcclient -U "" $ip</div><div><br/></div><div>enum4linux $ip</div><div><br/></div><div>enum4linux -a $ip</div></div><div><br/></div><div><ul><li><font style="font-size: 14pt;">SMB Finger Printing</font><br/></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>smbclient -L //$ip</div></div><div><div><span style="font-size: 18.6667px;"><br/></span></div><ul><li><font style="font-size: 14pt;">Nmap Scan for Open SMB Shares</font><br/></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>nmap -T4 -v -oA shares --script smb-enum-shares --script-args smbuser=username,smbpass=password -p445 192.168.10.0/24</div></div><div><div><span style="font-size: 18.6667px;"><br/></span></div><ul><li><font style="font-size: 14pt;">Nmap scans for vulnerable SMB Servers</font><br/></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>nmap -v -p 445 --script=smb-check-vulns --script-args=unsafe=1 $ip</div></div><div><div><span style="font-size: 18.6667px;"><br/></span></div><ul><li><font style="font-size: 14pt;">Nmap List all SMB scripts installed</font><br/></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>ls -l /usr/share/nmap/scripts/smb*</div></div><div><div><span style="font-size: 18.6667px;"><br/></span></div><ul><li><font style="font-size: 14pt;">Enumerate SMB Users</font></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>nmap -sU -sS --script=smb-enum-users -p U:137,T:139 $ip-14</div></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&nbsp;&nbsp;python /usr/share/doc/python-impacket-doc/examples /samrdump.py $ip</div></div><div><div><span style="font-size: 18.6667px;"><br/></span></div><ul><li><font style="font-size: 14pt;">RID Cycling - Null Sessions</font><br/></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>ridenum.py $ip 500 50000 dict.txt</div></div><div><ul><li><font style="font-size: 14pt;">Manual Null Session Testing</font><br/></li></ul></div><div><br/></div><div><ul><li><font style="font-size: 10pt;">&nbsp;&nbsp;Windows:</font></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>net use \\$ip\IPC$ "" /u:"</div></div><div><ul><li><font style="font-size: 10pt;">Linux:</font></li></ul></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>smbclient -L //$ip</div></div><div><br/></div><div><ul><li><font style="font-size: 14pt;"><span style="font-size: 14pt;">SMB Enumeration Techniques using Windows Tools:</span></font></li></ul></div><div><br/></div><div><span style="font-size: 12pt;">1. NetBIOS Enumerator (nbtenum)</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><a href="http://nbtenum.sourceforge.net/" style="font-size: 12pt; color: rgb(0, 0, 238); text-decoration: underline;">http://nbtenum.sourceforge.net/</a></div></div><div><br/></div><div><span style="font-size: 12pt;">[+] NBNS Spoof / Capture</span></div><div><br/></div><div><span style="font-size: 12pt;">[&gt;] NBNS Spoof</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 12pt;">msf &gt; use auxiliary/spoof/nbns/nbns_response</span></div><div><span style="font-size: 12pt;">msf auxiliary(nbns_response) &gt; show options</span></div><div><span style="font-size: 12pt;">msf auxiliary(nbns_response) &gt; set INTERFACE eth0</span></div><div><span style="font-size: 12pt;">msf auxiliary(nbns_response) &gt; set SPOOFIP 10.10.10.10</span></div><div><span style="font-size: 12pt;">msf auxiliary(nbns_response) &gt; run</span></div></div><div><br/></div><div><span style="font-size: 12pt;">[&gt;] SMB Capture</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 12pt;">msf &gt; use auxiliary/server/capture/smb</span></div><div><span style="font-size: 12pt;">msf auxiliary(smb) &gt; set JOHNPWFILE /tmp/john_smb</span></div><div><span style="font-size: 12pt;">msf auxiliary(smb) &gt; run</span></div></div><div><br/></div><div><span style="font-size: 12pt;">[&gt;] HTTP NTML Capture</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 12pt;">msf auxiliary(smb) &gt; use auxiliary/server/capture/http_ntlm</span></div><div><span style="font-size: 12pt;">msf auxiliary(smb) &gt; set JOHNPWFILE /tmp/john_http</span></div><div><span style="font-size: 12pt;">msf auxiliary(smb) &gt; set SRVPORT 80</span></div><div><span style="font-size: 12pt;">msf auxiliary(smb) &gt; set URIPATH /</span></div><div><span style="font-size: 12pt;">msf auxiliary(smb) &gt; run</span></div></div><div><br/></div><div><br/></div><div><span style="font-size: 12pt;">Fix:</span></div><div><a href="http://www.leonteale.co.uk/netbios-nbns-spoofing/" style="font-size: 12pt;">http://www.leonteale.co.uk/netbios-nbns-spoofing/</a></div><div><br/></div><div><span style="font-size: 12pt;">Solution</span></div><div><span style="font-size: 12pt;">The solution to this is to disable Netbios from broadcasting. The setting for this is in, what i hope, a very familiar place thaet you might not have really paid attention too before.</span></div><div><span style="font-size: 12pt;">netbios</span></div><div><span style="font-size: 12pt;">Netbios, according to Microsoft, is no longer needed as of Windows 2000.</span></div><div><span style="font-size: 12pt;">However, there are a few side effects.</span></div><div><span style="font-size: 12pt;">One of the unexpected consequences of disabling Netbios completely on your network is how this affects trusts between forests. Windows 2000 let you create an external (non-transitive) trust between a domain in one forest and a domain in a different forest so users in one forest could access resources in the trusting domain of the other forest. Windows Server 2003 takes this a step further by allowing you to create a new type of two-way transitive trusts called forest trusts that allow users in any domain of one forest access resources in any domain of the other forest. Amazingly, NetBIOS is actually still used in the trust creation process, even though Microsoft has officially “deprecated” NetBIOS in versions of Windows from 2000 on. So if you disable Netbios on your domain controllers, you won’t be able to establish a forest trust between two Windows Server 2003 forests.</span></div><div><span style="font-size: 12pt;">But Windows 2003 is pretty old, since as of writing we are generally on Windows 2012 now. So if you would like to disable Netbios on your servers yet will be effected by the side effect for Forest trusts then ideally you should upgrade and keep up with the times anyway. alternatively, you can get away with, at the very least, disabling Netbios on your workstations.</span></div><div><span style="font-size: 12pt;">See below for step by step instructions on disabling Netbios on workstations:</span></div><div><br/></div><div><span style="font-size: 12pt;">Windows XP, Windows Server 2003, and Windows 2000</span></div><div><span style="font-size: 12pt;">On the desktop, right-click My Network Places, and then click Properties.</span></div><div><span style="font-size: 12pt;">Right-click Local Area Connection, and then click Properties</span></div><div><span style="font-size: 12pt;">In the Components checked are used by this connection list, double-click Internet Protocol (TCP/IP), clickAdvanced, and then click the WINS tab.Note In Windows XP and in Windows Server 2003, you must double-click Internet Protocol (TCP/IP) in the This connection uses the following items list.</span></div><div><span style="font-size: 12pt;">Click Use NetBIOS setting from the DHCP server, and then click OK three times.</span></div><div><br/></div><div><span style="font-size: 12pt;">For Windows Vista</span></div><div><span style="font-size: 12pt;">On the desktop, right-click Network, and then click Properties.</span></div><div><span style="font-size: 12pt;">Under Tasks, click Manage network connections.</span></div><div><span style="font-size: 12pt;">Right-click Local Area Connection, and then click Properties</span></div><div><span style="font-size: 12pt;">In the This connection uses the following items list, double-click Internet Protocol Version 4 (TCP/IPv4), clickAdvanced, and then click the WINS tab.</span></div><div><span style="font-size: 12pt;">Click Use NetBIOS setting from the DHCP server, and then click OK three times.</span></div><div><br/></div><div><span style="font-size: 12pt;">For Windows 7</span></div><div><span style="font-size: 12pt;">Click Start, and then click Control Panel.</span></div><div><span style="font-size: 12pt;">Under Network and Internet, click View network status and tasks.</span></div><div><span style="font-size: 12pt;">Click Change adapter settings.</span></div><div><span style="font-size: 12pt;">Right-click Local Area Connection, and then click Properties.</span></div><div><span style="font-size: 12pt;">In the This connection uses the following items list, double-click Internet Protocol Version 4 (TCP/IPv4), clickAdvanced, and then click the WINS tab.</span></div><div><span style="font-size: 12pt;">Click Use NetBIOS setting from the DHCP server, and then click OK three times.</span></div></body></html>